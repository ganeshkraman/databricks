import pandas as pd
import os
import csv

# Loop through all Excel files in the current directory
for filename in os.listdir('.'):
    if filename.endswith('.xlsx') and not filename.startswith('~'):
        base_name = os.path.splitext(filename)[0]
        csv_file = base_name + '.csv'

        # Read the first sheet of the Excel file
        df = pd.read_excel(filename, sheet_name=0)

        # Remove newlines from all string fields
        df = df.applymap(
            lambda x: str(x).replace('\n', ' ').replace('\r', ' ') if isinstance(x, str) else x
        )

        # Track columns that contain newline characters
        columns_with_newlines = []

        for column in df.columns:
            # Check if any value in the column contains \n or \r
            if df[column].astype(str).str.contains('\n|\r').any():
                columns_with_newlines.append(column)

        # Print results
        if columns_with_newlines:
            print(f"{filename} contains newlines in columns: {columns_with_newlines}")
        else:
            print(f"{filename} has no columns with newlines.")

        # Write to CSV with all fields quoted
        df.to_csv(
            csv_file,
            index=False,
            quoting=csv.QUOTE_ALL,
            quotechar='"',
            sep=','
        )

        print(f"Converted: {filename} â†’ {csv_file} (newlines removed)")

